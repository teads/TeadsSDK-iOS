<!doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <style type="text/css">
            html, body {width: 100%; height: 100%; margin: 0; padding: 0; border: 0px;}
            #vpaid-slot {
                position: absolute;
                top: 0px;
                left: 0px;
            }
        </style>
    </head>
    <body>
        <div id="vpaid-container">
            <video id="vpaid-video" webkit-playsinline></video>
            <div id="vpaid-slot"></div>
        </div>
 
        <script type="text/javascript">
            // https://github.com/ebuzzing/lib-format-vpaid/blob/master/src/event/VPAIDEvent.ts
            var vpaidEvents = ["AdLoaded","AdStarted","AdStopped","AdSkipped","AdLinearChange","AdSizeChange","AdExpandedChange","AdSkippableStateChange","AdRemainingTimeChange","AdDurationChange","AdVolumeChange","AdImpression","AdVideoStart","AdVideoFirstQuartile","AdVideoMidpoint","AdVideoThirdQuartile","AdVideoComplete","AdClickThru","AdInteraction","AdUserAcceptInvitation","AdUserMinimize","AdUserClose","AdPaused","AdPlaying","AdLog","AdError" ];

            var container = document.getElementById("vpaid-slot");
            var video = document.getElementById("vpaid-video");
            var scr = document.createElement('script');
            var adParameters = {};
            
            // Queue to track pending calls to the native SDK.
            var nativeCallQueue = [];
            // Whether a native call is currently in progress.
            var nativeCallInFlight = false;

            // required to instanciate the VPAID ad, specified in the IAB VPAID JS spec
            var environmentVars = {
                "slot" : container,
                "videoSlot" : video, // not required
                "videoSlotCanAutoPlay" : true
            }

            scr.onload = function() {
                // retrieve the creative
                var vpaid = window.getVPAIDAd();

                // Expose to global scope to play with vpaid object in console :)
                window['vpaid'] = vpaid;

                // simple hack to handle all events
                // Handle dynamic arguments on vpaid callback !
                // ClickThru have 3 arguments,AdLog & AdError got one, others got none
                var onEventCallback = function(eventName) {
                  return function() {
                    var data = [eventName]
                    var args = Array.prototype.slice.call(arguments);
                    var l = args.length;
                    var url = "teads-sdk://"+eventName;

                    if (l > 0) {
                      url+="?";

                      for (var i = 0; i < l; i++) {
                          url += encodeURIComponent(arguments[i]);

                          if (i != (arguments.length - 1)) {
                            url += "&";
                          };
                      }
                    }
                    
                    console.log.apply(console, ['Got an Event ' + eventName, args]);


                    if (nativeCallInFlight) {
                        nativeCallQueue.push(url);
                    } else {
                        nativeCallInFlight = true;
                        window.location = url;
                    }
                  }
                }

                for (var i = 0; i < vpaidEvents.length; i++) { // teads.vpaid.VPAIDEvent object is always embed in vpaid js creative
                    vpaid.subscribe(onEventCallback(vpaidEvents[i]), vpaidEvents[i]);
                }

                // init the ad
                vpaid.initAd(document.body.offsetWidth, document.body.offsetHeight, 'normal', 512, adParameters, environmentVars);
                
            }
        
        scr.onerror = function(e) {
            console.log.apply(console, 'error', e);
        }
        

            window.onresize = function(e) {
                vpaid.resizeAd(document.body.offsetWidth, document.body.offsetHeight);
                video.style.width = document.body.offsetWidth + 'px';
                video.style.height = document.body.offsetHeight + 'px';
            }

            window.loadAd = function(adParams, vpaidUrl) {
              adParameters = adParams;

              if (adParameters == null) {
                adParameters = {};
              };

              scr.src = vpaidUrl;
              document.body.appendChild(scr);
            }
        
            window.nativeCallComplete = function(command) {
                if (nativeCallQueue.length === 0) {
                    nativeCallInFlight = false;
                    return;
                }
            
                var nextCall = nativeCallQueue.pop();
                window.location = nextCall;
            };

        </script>
    </body>
</html>